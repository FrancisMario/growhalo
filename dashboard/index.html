<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grow Halo — Dashboard</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --border: #2a2d3a;
    --text: #e4e4e7;
    --muted: #8b8d98;
    --green: #22c55e;
    --red: #ef4444;
    --blue: #3b82f6;
    --purple: #8b5cf6;
    --orange: #f59e0b;
    --cyan: #06b6d4;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding: 24px;
    min-height: 100vh;
  }
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
  }
  header h1 {
    font-size: 24px;
    font-weight: 700;
    background: linear-gradient(135deg, var(--blue), var(--purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  header .period-select {
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
  }
  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
  }
  .card .label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--muted);
    margin-bottom: 8px;
  }
  .card .value {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 6px;
  }
  .card .change {
    font-size: 13px;
    font-weight: 500;
  }
  .card .change.positive { color: var(--green); }
  .card .change.negative { color: var(--red); }
  .charts {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 32px;
  }
  @media (max-width: 900px) { .charts { grid-template-columns: 1fr; } }
  .chart-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
  }
  .chart-box h3 {
    font-size: 14px;
    color: var(--muted);
    margin-bottom: 16px;
    font-weight: 500;
  }
  .chart-box canvas {
    width: 100% !important;
    height: 220px !important;
  }
  .ad-table {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 32px;
  }
  .ad-table h3 {
    font-size: 14px;
    color: var(--muted);
    margin-bottom: 16px;
    font-weight: 500;
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    text-align: left;
    padding: 10px 14px;
    font-size: 14px;
  }
  th {
    color: var(--muted);
    font-weight: 500;
    border-bottom: 1px solid var(--border);
  }
  td { border-bottom: 1px solid var(--border); }
  tr:last-child td { border-bottom: none; }
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: var(--muted);
  }
  .dot { color: var(--blue); }
</style>
</head>
<body>

<header>
  <h1>!Grow Halo!</h1>
  <select class="period-select" id="periodSelect">
    <option value="last_7_days">Last 7 days</option>
    <option value="last_30_days" selected>Last 30 days</option>
    <option value="last_90_days">Last 90 days</option>
  </select>
</header>

<div class="cards" id="cards">
  <div class="loading">Loading…</div>
</div>

<div class="charts">
  <div class="chart-box">
    <h3>Revenue & Ad Spend</h3>
    <canvas id="revenueChart"></canvas>
  </div>
  <div class="chart-box">
    <h3>ROAS</h3>
    <canvas id="roasChart"></canvas>
  </div>
  <div class="chart-box">
    <h3>Orders & New Customers</h3>
    <canvas id="ordersChart"></canvas>
  </div>
  <div class="chart-box">
    <h3>Average Order Value</h3>
    <canvas id="aovChart"></canvas>
  </div>
</div>

<div class="ad-table" id="adTable">
  <h3>Ad Spend by Platform</h3>
  <div class="loading">Loading…</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
const $ = (s) => document.querySelector(s);
const API = '/api/v1';
let charts = {};

function fmt(n, type) {
  if (type === 'dollar') return '$' + Number(n).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  if (type === 'int') return Number(n).toLocaleString('en-US', { maximumFractionDigits: 0 });
  if (type === 'ratio') return Number(n).toFixed(2) + 'x';
  if (type === 'pct') return (n >= 0 ? '+' : '') + Number(n).toFixed(1) + '%';
  return String(n);
}

const metricConfig = [
  { key: 'revenue', label: 'Revenue', format: 'dollar' },
  { key: 'orders_count', label: 'Orders', format: 'int' },
  { key: 'new_customers', label: 'New Customers', format: 'int' },
  { key: 'ad_spend', label: 'Ad Spend', format: 'dollar' },
  { key: 'roas', label: 'ROAS', format: 'ratio' },
  { key: 'cac', label: 'CAC', format: 'dollar' },
  { key: 'avg_order_value', label: 'Avg Order Value', format: 'dollar' },
];

function periodToDates(period) {
  const end = new Date();
  const start = new Date();
  if (period === 'last_7_days') start.setDate(start.getDate() - 7);
  else if (period === 'last_30_days') start.setDate(start.getDate() - 30);
  else start.setDate(start.getDate() - 90);
  return {
    start: start.toISOString().slice(0, 10),
    end: end.toISOString().slice(0, 10),
  };
}

async function fetchJSON(url) {
  const r = await fetch(url);
  return r.json();
}

async function loadSummary(period) {
  const data = await fetchJSON(`${API}/metrics/summary?period=${period}`);
  const cardsEl = $('#cards');
  cardsEl.innerHTML = metricConfig.map(m => {
    const val = data.current[m.key];
    const chg = data.changes[m.key];
    const cls = chg >= 0 ? 'positive' : 'negative';
    // For CAC and ad_spend, negative is good
    const invertCls = (m.key === 'cac' || m.key === 'ad_spend') ? (chg <= 0 ? 'positive' : 'negative') : cls;
    return `<div class="card">
      <div class="label">${m.label}</div>
      <div class="value">${fmt(val, m.format)}</div>
      <div class="change ${invertCls}">${fmt(chg, 'pct')} vs prior period</div>
    </div>`;
  }).join('');
}

function makeChart(canvasId, labels, datasets, yFormat) {
  if (charts[canvasId]) charts[canvasId].destroy();
  const ctx = document.getElementById(canvasId).getContext('2d');
  charts[canvasId] = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' },
      plugins: {
        legend: { labels: { color: '#8b8d98', font: { size: 11 } } },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.dataset.label}: ${fmt(ctx.parsed.y, yFormat)}`
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#8b8d98', font: { size: 10 }, maxRotation: 0, maxTicksLimit: 10 },
          grid: { color: '#2a2d3a' },
        },
        y: {
          ticks: {
            color: '#8b8d98',
            font: { size: 10 },
            callback: (v) => yFormat === 'dollar' ? '$' + v.toLocaleString() : v
          },
          grid: { color: '#2a2d3a' },
        }
      }
    }
  });
}

async function loadTimeSeries(period) {
  const { start, end } = periodToDates(period);
  const gran = period === 'last_7_days' ? 'daily' : period === 'last_30_days' ? 'daily' : 'weekly';

  const [rev, roas, orders, aov] = await Promise.all([
    fetchJSON(`${API}/metrics?start=${start}&end=${end}&granularity=${gran}&metrics=revenue,ad_spend`),
    fetchJSON(`${API}/metrics?start=${start}&end=${end}&granularity=${gran}&metrics=roas`),
    fetchJSON(`${API}/metrics?start=${start}&end=${end}&granularity=${gran}&metrics=orders_count,new_customers`),
    fetchJSON(`${API}/metrics?start=${start}&end=${end}&granularity=${gran}&metrics=avg_order_value`),
  ]);

  const labels = rev.data.map(d => d.date);

  makeChart('revenueChart', labels, [
    { label: 'Revenue', data: rev.data.map(d => d.revenue), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.3 },
    { label: 'Ad Spend', data: rev.data.map(d => d.ad_spend), borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', fill: true, tension: 0.3 },
  ], 'dollar');

  makeChart('roasChart', labels, [
    { label: 'ROAS', data: roas.data.map(d => d.roas), borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: true, tension: 0.3 },
  ], 'ratio');

  makeChart('ordersChart', labels, [
    { label: 'Orders', data: orders.data.map(d => d.orders_count), borderColor: '#8b5cf6', tension: 0.3 },
    { label: 'New Customers', data: orders.data.map(d => d.new_customers), borderColor: '#06b6d4', tension: 0.3 },
  ], 'int');

  makeChart('aovChart', labels, [
    { label: 'AOV', data: aov.data.map(d => d.avg_order_value), borderColor: '#ec4899', backgroundColor: 'rgba(236,72,153,0.1)', fill: true, tension: 0.3 },
  ], 'dollar');
}

async function loadAdTable(period) {
  const { start, end } = periodToDates(period);
  const data = await fetchJSON(`${API}/metrics/ad-spend?start=${start}&end=${end}&group_by=source`);
  const el = $('#adTable');
  el.innerHTML = `<h3>Ad Spend by Platform</h3>
    <table>
      <thead><tr><th>Source</th><th>Spend</th><th>Revenue</th><th>ROAS</th><th>% of Total</th></tr></thead>
      <tbody>${data.data.map(r => `<tr>
        <td style="text-transform:capitalize">${r.source}</td>
        <td>${fmt(r.ad_spend, 'dollar')}</td>
        <td>${fmt(r.revenue, 'dollar')}</td>
        <td>${fmt(r.roas, 'ratio')}</td>
        <td>${Number(r.pct_of_total).toFixed(1)}%</td>
      </tr>`).join('')}</tbody>
    </table>`;
}

async function refresh() {
  const period = $('#periodSelect').value;
  await Promise.all([
    loadSummary(period),
    loadTimeSeries(period),
    loadAdTable(period),
  ]);
}

$('#periodSelect').addEventListener('change', refresh);
refresh();

// Auto-refresh every 15 seconds
setInterval(refresh, 3_000);
</script>
</body>
</html>
